package com.hhu.xst.ui;

import java.io.IOException;
import java.sql.Date;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

import android.annotation.SuppressLint;
import android.content.Context;
import android.content.Intent;
import android.graphics.Shader.TileMode;
import android.os.AsyncTask;
import android.os.Bundle;
import android.os.Message;
import android.support.v4.app.Fragment;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.AbsListView;
import android.widget.AdapterView;
import android.widget.AdapterView.OnItemClickListener;
import android.widget.BaseAdapter;
import android.widget.ImageButton;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.ListView;
import android.widget.SimpleAdapter;
import android.widget.TextView;
import android.widget.Toast;

import com.example.osnews.Article;
import com.example.osnews.ListAdapter;
import com.handmark.pulltorefresh.library.ILoadingLayout;
import com.handmark.pulltorefresh.library.PullToRefreshBase;
import com.handmark.pulltorefresh.library.PullToRefreshListView;
import com.hhu.xst.connectutil.News_List;
import com.hhu.xst.function.LoginActivity;
import com.hhu.xst.function.NewsActivity;
import com.hhu.xst.main.MainActivity;
import com.jereh.slidingdemo.R;

/**
 * @描述 在Fragment中要使用ListView，就要用ListFragment
 * */
@SuppressLint("SimpleDateFormat")
public class NewsFragment extends Fragment {
	PullToRefreshListView mPull;
	List<News_List>  newsList=new ArrayList<News_List>();
	private ILoadingLayout loadingLayout;
	ListView listView;
	private String path = "http://www.oschina.net/news";
	private ListAdapter adapter;
	
	
		@SuppressLint("HandlerLeak")
	private Handler handler = new Handler(){
		public void handleMessage(Message msg){
			switch(msg.what){
			case 1 :
				listview.setAdapter(adapter);
				break; 
			default:
				break;
			} 
		} 
	}; 

	/**
	 * @描述 在onCreateView中加载布局
	 * */
	@Override  
    public View onCreateView(LayoutInflater inflater, ViewGroup container,  
            Bundle savedInstanceState) {  
        View view = inflater.inflate(R.layout.fragment_news, container,false);  
        list = (ListView) view.findViewById(android.R.id.list);  
        initListView(view);
        return view;  
    }
	
	private void initListView(View view)
    {


        mPull=(PullToRefreshListView)view.findViewById(R.id.newslist);
        //mPull.setRefreshing(true);
        loadingLayout = mPull.getLoadingLayoutProxy();
        loadingLayout.setLastUpdatedLabel("");
        loadingLayout
                .setPullLabel(getString(R.string.pull_to_refresh_bottom_pull));
        loadingLayout
                .setRefreshingLabel(getString(R.string.pull_to_refresh_bottom_refreshing));
        loadingLayout
                .setReleaseLabel(getString(R.string.pull_to_refresh_bottom_release));
        // //滑动监听
        mPull.setOnScrollListener(new AbsListView.OnScrollListener() {

            @Override
            public void onScrollStateChanged(AbsListView view, int scrollState) {

            }

            @Override
            public void onScroll(AbsListView view, int firstVisibleItem,
                                 int visibleItemCount, int totalItemCount) {

                if (firstVisibleItem == 0) {
                    loadingLayout.setLastUpdatedLabel("");
                    loadingLayout
                            .setPullLabel(getString(R.string.pull_to_refresh_top_pull));
                    loadingLayout
                            .setRefreshingLabel(getString(R.string.pull_to_refresh_top_refreshing));
                    loadingLayout
                            .setReleaseLabel(getString(R.string.pull_to_refresh_top_release));
                } else if (firstVisibleItem + visibleItemCount + 1 == totalItemCount) {
                    loadingLayout.setLastUpdatedLabel("");
                    loadingLayout
                            .setPullLabel(getString(R.string.pull_to_refresh_bottom_pull));
                    loadingLayout
                            .setRefreshingLabel(getString(R.string.pull_to_refresh_bottom_refreshing));
                    loadingLayout
                            .setReleaseLabel(getString(R.string.pull_to_refresh_bottom_release));
                }
            }
        });

        // 下拉刷新监听
        mPull
                .setOnRefreshListener(new PullToRefreshBase.OnRefreshListener2<ListView>() {

                    @Override
                    public void onPullDownToRefresh(
                            PullToRefreshBase<ListView> refreshView) {
                        // 下拉刷新(从第一页开始装载数据)
                        new GetListData().execute(path);
                        //queryData(0,STATE_REFRESH,0,what);
                    }

                    @Override
                    public void onPullUpToRefresh(
                            PullToRefreshBase<ListView> refreshView) {
                        // 上拉加载更多(加载下一页数据)
                        new GetListData().execute(path);
                        //queryData(curPage, STATE_MORE,0,what);
                    }
                });


        listView=mPull.getRefreshableView();
       myListAdapter=new MyAdapter(getActivity());
        listView.setAdapter(myListAdapter);
        
    }
	
	class GetListData extends AsyncTask<String, Void, ArrayList<Article>> {
		@Override 
		protected ArrayList<News_List> doInBackground(String... arg0) {
			
			ArrayList<News_List> articleList =new ArrayList<News_List>();
			try {
				Document doc = Jsoup.connect(path).timeout(5000).get(); 
				Element masthead = doc.getElementById("all-news");
				System.out.println(masthead.text());
			    Elements articleElements =  masthead.select("div.item");
			    //System.out.println("555555555555555555"+articleElements.text());
				if (doc != null) { 
					for(int i = 0; i < articleElements.size(); i++) {
					    
					    Element articleElement = articleElements.get(i);
					    Elements itembox=articleElement.select("div.main-info");
					    
					    Elements imgitem=articleElement.select("div.thumb");
					    
					    String imgurl=imgitem.select("img").attr("src");
					    if(imgurl.length()>0){
					    	if(imgurl.charAt(0)!='h')
					    	imgurl="http://www.oschina.net"+imgurl;
					    }else imgurl="";
					    
					    Log.e("77777777777",imgurl);
					    String url=		itembox.select("a.title").attr("href");
					    url="http://www.oschina.net"+url;
					    
					    Elements titleElement = itembox.select("a.title span");
					    Elements summaryElement = itembox.select("div.sc");
					    Elements timeElement = itembox.select("div.from");
					    
					    String title = titleElement.text();
					    String summary = summaryElement.text();
					    //if(summary.length() > 70)
					    //	summary = summary.substring(0, 70);
					    String postTime = timeElement.text();
					    
					    System.out.print(title+"------------"+summary+"----------"+postTime);
					    Log.i("title", title);
					    Log.i("summary", summary); 
					    Log.i("postTime", postTime);
					    
					    Article article = new Article(title,summary,postTime,imgurl);
					    imgurl="";
					    articleList.add(article);
					 
					}
				} 
			} catch (IOException e) {
				
				System.out.println(".............****************************");
				e.printStackTrace(); 
				
			}return articleList; 
		} 
		@Override 
		protected void onPostExecute(ArrayList<Article> articleList) { 
		 
			super.onPostExecute(articleList); 
			adapter = new ListAdapter(MainActivity.this,R.layout.item_article_list,articleList); 
			Log.i("adapter", "----------"+adapter.isEmpty()); 
			Message msg = Message.obtain(); 
			msg.what=1; 
			handler.sendMessage(msg);
		} 
	} 
	
	
	
	
	
	
	
	
/**
 * 该方法用来为资讯填充内容
 */
	private void Tianchong() {
		// TODO Auto-generated method stub
		 SimpleDateFormat formatter = new SimpleDateFormat(
	    			"yyyy年MM月dd日    HH:mm:ss     ");
	    	Date curDate = new Date(System.currentTimeMillis());// 获取当前时间
	    	descs[0] = formatter.format(curDate);
	    	SimpleDateFormat sDateFormat = new SimpleDateFormat(
	    			"yyyy-MM-dd    hh:mm:ss");
	    	descs[1] = sDateFormat.format(new java.util.Date());
	    	SimpleDateFormat sdf=new SimpleDateFormat("yyyy-MM");    
	    	descs[2] = sdf.format(new java.util.Date());    
	    	List<Map<String,Object>> listItems = new ArrayList<Map<String,Object>>();
	    	for(int i = 0; i<names.length;i++){
	    		Map <String,Object> listItem = new HashMap<String, Object>();
	    		listItem.put("header", ImagIds[i]);
	    		listItem.put("personName", names[i]);
	    		listItem.put("desc",descs[i]);
	    		listItems.add(listItem);
	    	}
	    	/**
	    	 * 注：getActivity是一个值得记住的地方
	    	 */
	    	SimpleAdapter simple = new SimpleAdapter(getActivity(), listItems, R.layout.item_list, new String[]
					{"header","personName","desc"}, new int[]{R.id.header,R.id.name,R.id.desc});

	    	list.setAdapter(simple);
	    	list.setOnItemClickListener(new OnItemClickListener() {

				@Override
				public void onItemClick(AdapterView<?> parent, View view,
						int position, long id) {
					// TODO Auto-generated method stub
//					Toast toast=Toast.makeText(getActivity(),"这是第"+(position+1)+"条信息",Toast.LENGTH_SHORT);
//				    toast.show();
					/**
					 * title 用来向activity传递消息
					 */
				    title = "This is the news Page of " + String.valueOf(position) +" !";
				    Intent intent = new Intent(getActivity(),NewsActivity.class);
			//intent.setActivity(getActivity(), NewsActivity.class);
				    startActivity(intent);
				}
			});
	}
}